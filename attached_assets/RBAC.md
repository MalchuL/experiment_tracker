<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# –Ø —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –≤–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ FastAPI –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ DL —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ —é–∑–µ—Ä –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã (–≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞), –≥–∏–ø–æ—Ç–µ–∑—ã (–≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞). –Æ–∑–µ—Ä –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã. –í –∫–æ–º–∞–Ω–¥–µ –µ—Å—Ç—å —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã –∏ –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —á–ª–µ–Ω–æ–≤ –∫–æ–º–∞–Ω–¥—ã. –ù–∞–ø—Ä–∏–º–µ—Ä –∫—Ç–æ-—Ç–æ –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å —á—Ç–æ —Ö–æ—á–µ—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ, –∞ –∫—Ç–æ-—Ç–æ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å. –ò —ç—Ç–æ –º–æ–∂–Ω–æ –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å. –ö–∞–∫ –º–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Å–µ–≥–æ —ç—Ç–æ–≥–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ?

–û—Ç–ª–∏—á–Ω–æ! –í–æ—Ç –ø–æ–ª–Ω—ã–π –≥–∞–π–¥ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è —Ç–≤–æ–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ DL —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ü–æ–¥—Ö–æ–¥

–Ø —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é RBAC (Role-Based Access Control)** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π **–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø—Ä–æ–µ–∫—Ç—É/–∫–æ–º–∞–Ω–¥–µ). –í–æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

### 1. **Database Schema**

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î (—è –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQLAlchemy ORM):

```python
# models/core.py
from sqlalchemy import Column, String, UUID, DateTime, ForeignKey, Table, Boolean, Integer, Text
from sqlalchemy.orm import relationship
from datetime import datetime
import uuid

# Association tables
team_members = Table(
    'team_members',
    Base.metadata,
    Column('user_id', UUID(as_uuid=True), ForeignKey('users.id')),
    Column('team_id', UUID(as_uuid=True), ForeignKey('teams.id')),
    Column('role_id', UUID(as_uuid=True), ForeignKey('team_roles.id')),
)

project_members = Table(
    'project_members',
    Base.metadata,
    Column('user_id', UUID(as_uuid=True), ForeignKey('users.id')),
    Column('project_id', UUID(as_uuid=True), ForeignKey('projects.id')),
    Column('role_id', UUID(as_uuid=True), ForeignKey('project_roles.id')),
)

class User(Base):
    __tablename__ = "users"
    
    id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
    username: Mapped[str] = mapped_column(unique=True)
    email: Mapped[str] = mapped_column(unique=True)
    hashed_password: Mapped[str]
    created_at: Mapped[datetime] = mapped_column(default=datetime.utcnow)
    
    # Relationships
    teams: Mapped[list["Team"]] = relationship(secondary=team_members)
    projects: Mapped[list["Project"]] = relationship(secondary=project_members)
    personal_projects: Mapped[list["Project"]] = relationship(back_populates="owner")

class Team(Base):
    __tablename__ = "teams"
    
    id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
    name: Mapped[str]
    description: Mapped[str | None]
    created_at: Mapped[datetime] = mapped_column(default=datetime.utcnow)
    
    # Relationships
    members: Mapped[list["User"]] = relationship(secondary=team_members)
    projects: Mapped[list["Project"]] = relationship(back_populates="team")
    roles: Mapped[list["TeamRole"]] = relationship(back_populates="team")

class Project(Base):
    __tablename__ = "projects"
    
    id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
    name: Mapped[str]
    description: Mapped[str | None]
    is_team_project: Mapped[bool] = mapped_column(default=False)
    created_at: Mapped[datetime] = mapped_column(default=datetime.utcnow)
    
    # Foreign Keys
    owner_id: Mapped[uuid.UUID | None] = mapped_column(ForeignKey("users.id"), nullable=True)
    team_id: Mapped[uuid.UUID | None] = mapped_column(ForeignKey("teams.id"), nullable=True)
    
    # Relationships
    owner: Mapped["User"] = relationship(back_populates="personal_projects")
    team: Mapped["Team | None"] = relationship(back_populates="projects")
    members: Mapped[list["User"]] = relationship(secondary=project_members)
    experiments: Mapped[list["Experiment"]] = relationship(back_populates="project")
    hypotheses: Mapped[list["Hypothesis"]] = relationship(back_populates="project")

class Experiment(Base):
    __tablename__ = "experiments"
    
    id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
    project_id: Mapped[uuid.UUID] = mapped_column(ForeignKey("projects.id"))
    name: Mapped[str]
    description: Mapped[str | None]
    created_at: Mapped[datetime] = mapped_column(default=datetime.utcnow)
    
    project: Mapped["Project"] = relationship(back_populates="experiments")
    hypotheses: Mapped[list["Hypothesis"]] = relationship(back_populates="experiment")

class Hypothesis(Base):
    __tablename__ = "hypotheses"
    
    id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
    project_id: Mapped[uuid.UUID] = mapped_column(ForeignKey("projects.id"))
    name: Mapped[str]
    description: Mapped[str | None]
    created_at: Mapped[datetime] = mapped_column(default=datetime.utcnow)
    
    project: Mapped["Project"] = relationship(back_populates="hypotheses")

# Permission –∏ Role Models
class Permission(Base):
    __tablename__ = "permissions"
    
    id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
    name: Mapped[str] = mapped_column(unique=True)  # e.g., "project:read", "project:write", "project:delete"
    description: Mapped[str | None]

class TeamRole(Base):
    __tablename__ = "team_roles"
    
    id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
    team_id: Mapped[uuid.UUID] = mapped_column(ForeignKey("teams.id"))
    name: Mapped[str]  # e.g., "Admin", "Editor", "Viewer"
    permissions: Mapped[list["Permission"]] = relationship(
        secondary=Table(
            'team_role_permissions',
            Base.metadata,
            Column('role_id', UUID(as_uuid=True), ForeignKey('team_roles.id')),
            Column('permission_id', UUID(as_uuid=True), ForeignKey('permissions.id')),
        )
    )
    
    team: Mapped["Team"] = relationship(back_populates="roles")

class ProjectRole(Base):
    __tablename__ = "project_roles"
    
    id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
    project_id: Mapped[uuid.UUID] = mapped_column(ForeignKey("projects.id"))
    name: Mapped[str]  # e.g., "Owner", "Editor", "Viewer"
    permissions: Mapped[list["Permission"]] = relationship(
        secondary=Table(
            'project_role_permissions',
            Base.metadata,
            Column('role_id', UUID(as_uuid=True), ForeignKey('project_roles.id')),
            Column('permission_id', UUID(as_uuid=True), ForeignKey('permissions.id')),
        )
    )
    
    project: Mapped["Project"] = relationship()
```


### 2. **Permission System —Å Dependency Injection**

```python
# auth/permissions.py
from typing import List
from fastapi import Depends, HTTPException, status
from sqlalchemy.orm import Session
from sqlalchemy import select
import uuid

class PermissionChecker:
    def __init__(self, required_permissions: List[str]):
        self.required_permissions = required_permissions
    
    async def __call__(
        self,
        current_user: User = Depends(get_current_user),
        db: Session = Depends(get_db),
        project_id: uuid.UUID = None,  # Pass as path param
    ) -> User:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω—É–∂–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ–µ–∫—Ç
        """
        if not project_id:
            raise HTTPException(status_code=400, detail="project_id required")
        
        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç
        project = db.execute(
            select(Project).where(Project.id == project_id)
        ).scalar_one_or_none()
        
        if not project:
            raise HTTPException(status_code=404, detail="Project not found")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
        user_permissions = await self._get_user_permissions(
            current_user, project, db
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        for perm in self.required_permissions:
            if perm not in user_permissions:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail=f"Permission denied: {perm}"
                )
        
        return current_user
    
    async def _get_user_permissions(
        self, user: User, project: Project, db: Session
    ) -> set[str]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
        """
        permissions = set()
        
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –ª–∏—á–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
        if project.owner_id == user.id:
            permissions.update([
                "project:read", "project:write", "project:delete",
                "experiment:create", "experiment:read", "experiment:write", "experiment:delete",
                "hypothesis:create", "hypothesis:read", "hypothesis:write", "hypothesis:delete",
            ])
            return permissions
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –≤ –∫–æ–º–∞–Ω–¥–µ (–µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–µ–∫—Ç –∫–æ–º–∞–Ω–¥—ã)
        if project.team_id:
            team_role = db.execute(
                select(TeamRole).join(
                    team_members
                ).where(
                    team_members.c.user_id == user.id,
                    team_members.c.team_id == project.team_id,
                )
            ).scalar_one_or_none()
            
            if team_role:
                for perm in team_role.permissions:
                    permissions.add(perm.name)
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä—è–º—É—é —Ä–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
        project_role = db.execute(
            select(ProjectRole).join(
                project_members
            ).where(
                project_members.c.user_id == user.id,
                project_members.c.project_id == project.id,
            )
        ).scalar_one_or_none()
        
        if project_role:
            for perm in project_role.permissions:
                permissions.add(perm.name)
        
        return permissions


# –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
async def require_permission(
    permissions: List[str] = ["project:read"]
):
    """Factory –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è PermissionChecker"""
    return PermissionChecker(permissions)
```


### 3. **Endpoints —Å –∑–∞—â–∏—Ç–æ–π**

```python
# routes/projects.py
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
import uuid

router = APIRouter(prefix="/projects", tags=["projects"])

@router.get("/{project_id}")
async def get_project(
    project_id: uuid.UUID,
    current_user: User = Depends(get_current_user),
    _: User = Depends(require_permission(["project:read"])),
    db: Session = Depends(get_db),
):
    """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–µ–∫—Ç (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤)"""
    project = db.execute(
        select(Project).where(Project.id == project_id)
    ).scalar_one_or_none()
    
    if not project:
        raise HTTPException(status_code=404, detail="Project not found")
    
    return {"id": project.id, "name": project.name}

@router.post("/{project_id}/experiments")
async def create_experiment(
    project_id: uuid.UUID,
    name: str,
    current_user: User = Depends(get_current_user),
    _: User = Depends(require_permission(["experiment:create"])),
    db: Session = Depends(get_db),
):
    """–°–æ–∑–¥–∞—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç (—Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è)"""
    project = db.execute(
        select(Project).where(Project.id == project_id)
    ).scalar_one_or_none()
    
    if not project:
        raise HTTPException(status_code=404, detail="Project not found")
    
    experiment = Experiment(project_id=project_id, name=name)
    db.add(experiment)
    db.commit()
    
    return {"id": experiment.id, "name": experiment.name}

@router.post("/{project_id}/members")
async def add_team_member(
    project_id: uuid.UUID,
    user_id: uuid.UUID,
    role_id: uuid.UUID,
    current_user: User = Depends(get_current_user),
    _: User = Depends(require_permission(["project:write"])),  # –¢–æ–ª—å–∫–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
    db: Session = Depends(get_db),
):
    """–î–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥—ã (—Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)"""
    project = db.execute(
        select(Project).where(Project.id == project_id)
    ).scalar_one_or_none()
    
    if not project:
        raise HTTPException(status_code=404, detail="Project not found")
    
    # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ä–æ–ª—å –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –ø—Ä–æ–µ–∫—Ç–µ
    # ... –ª–æ–≥–∏–∫–∞
    
    return {"success": True}
```


### 4. **–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–æ–ª–µ–π –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π**

```python
# auth/defaults.py
from enum import Enum

class PermissionEnum(str, Enum):
    # Project permissions
    PROJECT_READ = "project:read"
    PROJECT_WRITE = "project:write"
    PROJECT_DELETE = "project:delete"
    PROJECT_MANAGE_MEMBERS = "project:manage_members"
    
    # Experiment permissions
    EXPERIMENT_CREATE = "experiment:create"
    EXPERIMENT_READ = "experiment:read"
    EXPERIMENT_WRITE = "experiment:write"
    EXPERIMENT_DELETE = "experiment:delete"
    
    # Hypothesis permissions
    HYPOTHESIS_CREATE = "hypothesis:create"
    HYPOTHESIS_READ = "hypothesis:read"
    HYPOTHESIS_WRITE = "hypothesis:write"
    HYPOTHESIS_DELETE = "hypothesis:delete"

class DefaultTeamRoles:
    """–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–æ–ª–µ–π –¥–ª—è –∫–æ–º–∞–Ω–¥"""
    
    ADMIN = {
        "name": "Admin",
        "permissions": [
            PermissionEnum.PROJECT_READ,
            PermissionEnum.PROJECT_WRITE,
            PermissionEnum.PROJECT_DELETE,
            PermissionEnum.PROJECT_MANAGE_MEMBERS,
            PermissionEnum.EXPERIMENT_CREATE,
            PermissionEnum.EXPERIMENT_READ,
            PermissionEnum.EXPERIMENT_WRITE,
            PermissionEnum.EXPERIMENT_DELETE,
            PermissionEnum.HYPOTHESIS_CREATE,
            PermissionEnum.HYPOTHESIS_READ,
            PermissionEnum.HYPOTHESIS_WRITE,
            PermissionEnum.HYPOTHESIS_DELETE,
        ]
    }
    
    EDITOR = {
        "name": "Editor",
        "permissions": [
            PermissionEnum.PROJECT_READ,
            PermissionEnum.PROJECT_WRITE,
            PermissionEnum.EXPERIMENT_CREATE,
            PermissionEnum.EXPERIMENT_READ,
            PermissionEnum.EXPERIMENT_WRITE,
            PermissionEnum.HYPOTHESIS_CREATE,
            PermissionEnum.HYPOTHESIS_READ,
            PermissionEnum.HYPOTHESIS_WRITE,
        ]
    }
    
    VIEWER = {
        "name": "Viewer",
        "permissions": [
            PermissionEnum.PROJECT_READ,
            PermissionEnum.EXPERIMENT_READ,
            PermissionEnum.HYPOTHESIS_READ,
        ]
    }

class DefaultProjectRoles:
    """–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–æ–ª–µ–π –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤"""
    
    OWNER = {
        "name": "Owner",
        "permissions": [
            perm for perm in PermissionEnum
        ]
    }
    
    COLLABORATOR = {
        "name": "Collaborator",
        "permissions": [
            PermissionEnum.PROJECT_READ,
            PermissionEnum.PROJECT_WRITE,
            PermissionEnum.EXPERIMENT_CREATE,
            PermissionEnum.EXPERIMENT_READ,
            PermissionEnum.EXPERIMENT_WRITE,
            PermissionEnum.HYPOTHESIS_CREATE,
            PermissionEnum.HYPOTHESIS_READ,
            PermissionEnum.HYPOTHESIS_WRITE,
        ]
    }
    
    VIEWER = {
        "name": "Viewer",
        "permissions": [
            PermissionEnum.PROJECT_READ,
            PermissionEnum.EXPERIMENT_READ,
            PermissionEnum.HYPOTHESIS_READ,
        ]
    }
```


### 5. **–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (Advanced)**

```python
# routes/admin.py - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏
from fastapi import APIRouter

router = APIRouter(prefix="/admin", tags=["admin"])

@router.post("/teams/{team_id}/roles")
async def create_custom_role(
    team_id: uuid.UUID,
    role_name: str,
    permissions: List[str],
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """–°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é —Ä–æ–ª—å –≤ –∫–æ–º–∞–Ω–¥–µ"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º –∫–æ–º–∞–Ω–¥—ã
    # ... –ø—Ä–æ–≤–µ—Ä–∫–∞
    
    # –°–æ–∑–¥–∞–µ–º —Ä–æ–ª—å
    new_role = TeamRole(team_id=team_id, name=role_name)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
    for perm_name in permissions:
        permission = db.execute(
            select(Permission).where(Permission.name == perm_name)
        ).scalar_one_or_none()
        
        if permission:
            new_role.permissions.append(permission)
    
    db.add(new_role)
    db.commit()
    
    return {"id": new_role.id, "name": new_role.name, "permissions": permissions}

@router.put("/projects/{project_id}/members/{user_id}/role")
async def update_member_role(
    project_id: uuid.UUID,
    user_id: uuid.UUID,
    role_id: uuid.UUID,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å —á–ª–µ–Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # ... –ø—Ä–æ–≤–µ—Ä–∫–∞
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å
    # ...
    
    return {"success": True}
```


## Key Points:

1. **–ò–µ—Ä–∞—Ä—Ö–∏—è –¥–æ—Å—Ç—É–ø–∞**: –õ–∏—á–Ω—ã–π –ø—Ä–æ–µ–∫—Ç (–º–∞–∫—Å–∏–º—É–º –ø—Ä–∞–≤) ‚Üí –ü—Ä–æ–µ–∫—Ç –∫–æ–º–∞–Ω–¥—ã ‚Üí –ü—Ä—è–º–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ
2. **–ì–∏–±–∫–æ—Å—Ç—å**: –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–º–±–∏–Ω–∏—Ä—É—é—Ç—Å—è –≤ —Ä–æ–ª–∏, —Ä–æ–ª–∏ –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
3. **Performance**: –ö–µ—à–∏—Ä—É–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Å—Å–∏—é (–º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis)
4. **Scalability**: SQL –∑–∞–ø—Ä–æ—Å—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –ø–æ `user_id`, `project_id`, `team_id`

–•–æ—á–µ—à—å, —è –ø–æ–∫–∞–∂—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é **–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π** –∏–ª–∏ **–∞—É–¥–∏—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø–∞**?
<span style="display:none">[^1_1][^1_10][^1_11][^1_12][^1_13][^1_14][^1_15][^1_2][^1_3][^1_4][^1_5][^1_6][^1_7][^1_8][^1_9]</span>

<div align="center">‚ÅÇ</div>

[^1_1]: https://app-generator.dev/docs/technologies/fastapi/rbac.html

[^1_2]: http://www.zigpoll.com/content/what-database-schema-do-you-recommend-using-to-efficiently-manage-owner-permissions-and-roles-across-multiple-projects

[^1_3]: https://stackoverflow.com/questions/79285538/add-auth-to-fastapi-via-middleware-and-include-in-openapi

[^1_4]: https://www.youtube.com/watch?v=RRG5l8wJoTI

[^1_5]: https://www.tencentcloud.com/techpedia/122735

[^1_6]: https://www.propelauth.com/post/fastapi-auth-with-dependency-injection

[^1_7]: https://www.reddit.com/r/FastAPI/comments/1jn1203/how_do_you_handle_rebac_abac_and_rbac_in_fastapi/

[^1_8]: https://www.cerbos.dev/blog/designing-an-authorization-model-for-an-enterprise

[^1_9]: https://fastapi-keycloak-middleware.readthedocs.io/en/latest/authorization.html

[^1_10]: https://auth0.com/blog/implementing-rbac-fastapi-auth0-fga/

[^1_11]: https://blog.montrealanalytics.com/role-based-access-control-for-data-teams-part-1-617a768e6f3f

[^1_12]: https://pypi.org/project/fastapi-auth-middlewares/

[^1_13]: https://www.permit.io/blog/fastapi-rbac-full-implementation-tutorial

[^1_14]: https://learn.microsoft.com/en-us/azure/devops/boards/plans/configure-hierarchical-teams?view=azure-devops

[^1_15]: https://www.oneloop.ai/blog/setting-up-middleware-in-fastapi


---

# –ê —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞? –µ—Å–ª–∏ —è —Ö–æ—á—É –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–æ–µ–∫—Ç—É

–î–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ **–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–æ–µ–∫—Ç—É** –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–∞–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°–µ–∫—Ä–µ—Ç–Ω—ã–π –ü—Ä–æ–µ–∫—Ç" –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–∞–Ω–¥—ã "ML Engineers"), –Ω—É–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å –∫–æ–Ω—Ü–µ–ø—Ü–∏—é **"–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –ü—Ä–æ–µ–∫—Ç–∞"** –∏ **"–Ø–≤–Ω–æ–≥–æ –ß–ª–µ–Ω—Å—Ç–≤–∞"**.

–í–æ—Ç –∫–∞–∫ —ç—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–≤–µ—Ä—Ö –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ö–µ–º—ã.

### 1. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –°—Ö–µ–º—ã –ë–î (Project Visibility)

–î–æ–±–∞–≤—å –ø–æ–ª–µ `visibility` –≤ –º–æ–¥–µ–ª—å `Project`. –≠—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç, –Ω–∞—Å–ª–µ–¥—É—é—Ç –ª–∏ —á–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

```python
import enum
from sqlalchemy import Enum as PgEnum

class ProjectVisibility(str, enum.Enum):
    TEAM = "team"       # –í–∏–¥–µ–Ω –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∫–æ–º–∞–Ω–¥—ã (–∫–∞–∫ Viewer –∏–ª–∏ –≤—ã—à–µ)
    PRIVATE = "private" # –í–∏–¥–µ–Ω –¢–û–õ–¨–ö–û —Ç–µ–º, –∫—Ç–æ —è–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ project_members

class Project(Base):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    visibility: Mapped[ProjectVisibility] = mapped_column(
        PgEnum(ProjectVisibility), 
        default=ProjectVisibility.TEAM
    )
```


### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –õ–æ–≥–∏–∫–∞ –ü—Ä–æ–≤–µ—Ä–∫–∏ –ü—Ä–∞–≤

–õ–æ–≥–∏–∫–∞ `PermissionChecker` –¥–æ–ª–∂–Ω–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–∞–∫:

1. –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç **Private**, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ä–æ–ª—å –≤ –∫–æ–º–∞–Ω–¥–µ. –°–º–æ—Ç—Ä–∏–º *—Ç–æ–ª—å–∫–æ* –Ω–∞ —Ç–∞–±–ª–∏—Ü—É `project_members`.
2. –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç **Team** (–ø—É–±–ª–∏—á–Ω—ã–π –¥–ª—è –∫–æ–º–∞–Ω–¥—ã), –±–µ—Ä–µ–º –ø—Ä–∞–≤–∞ –∏–∑ –∫–æ–º–∞–Ω–¥—ã.
3. **Override (–í–∞–∂–Ω–æ):** –ï—Å–ª–∏ —é–∑–µ—Ä –µ—Å—Ç—å *–∏* –≤ –∫–æ–º–∞–Ω–¥–µ, *–∏* —è–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç, —Ä–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∏–ª–∏ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å—Å—è). –û–±—ã—á–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–µ—Ç—Å—è **–±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π —Ä–æ–ª–∏** (–ø—Ä–æ–µ–∫—Ç–Ω–æ–π).

–í–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `_get_user_permissions`:

```python
async def _get_user_permissions(
    self, user: User, project: Project, db: Session
) -> set[str]:
    permissions = set()
    
    # 1. –í–ª–∞–¥–µ–ª–µ—Ü –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
    if project.owner_id == user.id:
        return self._get_full_permissions()

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–Ω—É—é —Ä–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ (ProjectRole)
    # –≠—Ç–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç (–∏–ª–∏ –¥–æ–ø–æ–ª–Ω—è–µ—Ç) –∫–æ–º–∞–Ω–¥–Ω—É—é —Ä–æ–ª—å
    project_role = db.execute(
        select(ProjectRole).join(project_members).where(
            project_members.c.user_id == user.id,
            project_members.c.project_id == project.id,
        )
    ).scalar_one_or_none()

    if project_role:
        for perm in project_role.permissions:
            permissions.add(perm.name)
            
    # 3. –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –ü–£–ë–õ–ò–ß–ù–´–ô –¥–ª—è –∫–æ–º–∞–Ω–¥—ã –∏ —É —é–∑–µ—Ä–∞ –ù–ï–¢ —è–≤–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    # (–µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ strict private, —Ç–æ —à–∞–≥ 3 –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ visibility == TEAM)
    if project.visibility == ProjectVisibility.TEAM and project.team_id:
        team_role = db.execute(
            select(TeamRole).join(team_members).where(
                team_members.c.user_id == user.id,
                team_members.c.team_id == project.team_id,
            )
        ).scalar_one_or_none()
        
        if team_role:
            for perm in team_role.permissions:
                permissions.add(perm.name)

    return permissions
```


### 3. –°—Ü–µ–Ω–∞—Ä–∏–∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–í–æ—Ç –∫–∞–∫ —ç—Ç–æ —Ä–µ—à–∞–µ—Ç —Ç–≤–æ–∏ –∑–∞–¥–∞—á–∏:

#### –°—Ü–µ–Ω–∞—Ä–∏–π –ê: "–°–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –≤ –∫–æ–º–∞–Ω–¥–µ"

* –°–æ–∑–¥–∞–µ—à—å –ø—Ä–æ–µ–∫—Ç –≤ –∫–æ–º–∞–Ω–¥–µ c `visibility = PRIVATE`.
* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é **–Ω–∏–∫—Ç–æ** –∏–∑ –∫–æ–º–∞–Ω–¥—ã –µ–≥–æ –Ω–µ –≤–∏–¥–∏—Ç (–∫—Ä–æ–º–µ —Å–æ–∑–¥–∞—Ç–µ–ª—è).
* –¢—ã –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª—è–µ—à—å –í–∞—Å—é –∏ –ü–µ—Ç—é –≤ `project_members` (—Ç–∞–±–ª–∏—Ü–∞ —Å–≤—è–∑–∏ `users <-> projects`).
* **–ò—Ç–æ–≥:** –í–∞—Å—è –∏ –ü–µ—Ç—è –≤–∏–¥—è—Ç –ø—Ä–æ–µ–∫—Ç, –ö–æ–ª—è (—Ç–æ–∂–µ –∏–∑ –∫–æ–º–∞–Ω–¥—ã) ‚Äî –Ω–µ—Ç.


#### –°—Ü–µ–Ω–∞—Ä–∏–π –ë: "–í–Ω–µ—à–Ω–∏–π –ê—É–¥–∏—Ç–æ—Ä" (–ì–æ—Å—Ç—å)

* –ï—Å—Ç—å –ø—Ä–æ–µ–∫—Ç –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–∞–Ω–¥—ã.
* –ü—Ä–∏–≥–ª–∞—à–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫–∞ *–∏–∑–≤–Ω–µ* (–æ–Ω –Ω–µ —á–ª–µ–Ω –∫–æ–º–∞–Ω–¥—ã `Team`).
* –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—à—å –µ–≥–æ –≤ `project_members` —Å —Ä–æ–ª—å—é `Viewer`.
* **–ò—Ç–æ–≥:** –û–Ω –≤–∏–¥–∏—Ç –¢–û–õ–¨–ö–û —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç, –Ω–æ –Ω–µ –≤–∏–¥–∏—Ç –¥—Ä—É–≥–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –∫–æ–º–∞–Ω–¥—ã.


#### –°—Ü–µ–Ω–∞—Ä–∏–π –í: "–ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∞–≤" (Override)

* –í –∫–æ–º–∞–Ω–¥–µ –í–∞—Å—è ‚Äî `Viewer` (–º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Å–º–æ—Ç—Ä–µ—Ç—å).
* –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç X" —Ç—ã –¥–æ–±–∞–≤–ª—è–µ—à—å –í–∞—Å—é –≤ `project_members` —Å —Ä–æ–ª—å—é `Editor`.
* **–ò—Ç–æ–≥:** –í–∞—Å—è –≤–∏–¥–∏—Ç –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –∫–æ–º–∞–Ω–¥—ã (–∫–∞–∫ Viewer), –Ω–æ –≤ "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ X" –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥–∏–ø–æ—Ç–µ–∑—ã.[^2_1]


### 4. API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º –∫ –ø—Ä–æ–µ–∫—Ç—É

–¢–µ–±–µ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–µ–∫—Ç–Ω—ã–º–∏ –¥–æ—Å—Ç—É–ø–∞–º–∏:

```python
@router.put("/projects/{project_id}/visibility")
async def update_visibility(
    project_id: uuid.UUID,
    visibility: ProjectVisibility,
    current_user: User = Depends(get_current_user),
    _: User = Depends(require_permission(["project:write"])), # –ù—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞/–≤–ª–∞–¥–µ–ª—å—Ü–∞
    db: Session = Depends(get_db)
):
    """–°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –∏–ª–∏ –∫–æ–º–∞–Ω–¥–Ω—ã–º"""
    # ... update logic ...
    return {"status": "updated"}

@router.post("/projects/{project_id}/members")
async def add_project_member(
    project_id: uuid.UUID,
    user_id: uuid.UUID,
    role_id: uuid.UUID,
    # ...
):
    """–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —é–∑–µ—Ä–∞ –≤ –ø—Ä–æ–µ–∫—Ç (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –Ω–µ –≤ –∫–æ–º–∞–Ω–¥–µ)"""
    # ... logic ...
```


### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è UI

–í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å–¥–µ–ª–∞–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å:

* üîò **Visible to Team** (–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã –≤–∏–¥—è—Ç –ø—Ä–æ–µ–∫—Ç)
* üîò **Private** (–¢–æ–ª—å–∫–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏)

–≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω (–∫–∞–∫ –≤ GitHub/GitLab/Jira), –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–æ–Ω—è—Ç–µ–Ω —Ç–≤–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.[^2_2][^2_3]
<span style="display:none">[^2_10][^2_11][^2_12][^2_13][^2_14][^2_15][^2_4][^2_5][^2_6][^2_7][^2_8][^2_9]</span>

<div align="center">‚ÅÇ</div>

[^2_1]: https://flowfuse.com/docs/user/role-based-access-control/

[^2_2]: https://tecnofor.es/en/team-managed-projects-vs-company-managed-projects/

[^2_3]: https://support.atlassian.com/jira-service-management-cloud/docs/overview-of-permissions-in-team-managed-service-projects/

[^2_4]: https://www.matia.io/blog/what-is-role-based-access-control-a-modern-guide-for-data-teams

[^2_5]: https://learn.microsoft.com/en-us/azure/role-based-access-control/overview

[^2_6]: https://blog.montrealanalytics.com/role-based-access-control-for-data-teams-part-1-617a768e6f3f

[^2_7]: https://www.reddit.com/r/snowflake/comments/14xo3ae/schemabased_rbac_design_is_it_practical_in_real/

[^2_8]: https://stackoverflow.com/questions/7329150/db-schema-for-rbac-with-multiple-levels-of-roles

[^2_9]: https://docs.digital.ai/teamforge/docs/projectadmin-controllingprojectaccess

[^2_10]: https://aerospike.com/blog/role-based-access-control-rbac-guide/

[^2_11]: https://support.teamwork.com/projects/project-sections/setting-user-permissions-on-a-project

[^2_12]: https://www.deltastream.io/blog/data-governance-for-teams-rbac/

[^2_13]: https://nordlayer.com/learn/access-control/role-based-access-control-implementation/

[^2_14]: https://www.osohq.com/learn/rbac-role-based-access-control

[^2_15]: https://forum.asana.com/t/team-permissions-vs-project-permissions/833954


---

# –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å ABAC –≤ –¥–∞–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?

–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! ABAC (Attribute-Based Access Control) –¥–∞—Å—Ç —Ç–µ–±–µ –Ω–∞–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ –≥–∏–±–∫–æ—Å—Ç–∏. –í–æ—Ç –∫–∞–∫ —ç—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ DL —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤.

## RBAC vs ABAC: –≤ —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞?

| –ê—Å–ø–µ–∫—Ç | RBAC | ABAC |
| :-- | :-- | :-- |
| **–ü—Ä–∏–Ω—Ü–∏–ø** | –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–æ–ª–∏ (Admin, Editor, Viewer) | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã (–∫—Ç–æ, —á—Ç–æ, –≥–¥–µ, –∫–æ–≥–¥–∞) |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | –ü—Ä–æ—Å—Ç–∞—è | –°–ª–æ–∂–Ω–∞—è, –Ω–æ –≥–∏–±–∫–∞—è |
| **–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª** | "–ï—Å–ª–∏ —Ä–æ–ª—å = Admin, —Ç–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å" | "–ï—Å–ª–∏ (—Ä–æ–ª—å = Reviewer) –ò (–ø—Ä–æ–µ–∫—Ç.—Å—Ç–∞—Ç—É—Å = –Ω–∞_—Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏) –ò (—á–∞—Å >= 9 –∏ —á–∞—Å <= 18), —Ç–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å" |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | –°—Ç—Ä–∞–¥–∞–µ—Ç –æ—Ç "role explosion" | –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ª—É—á—à–µ |

## –î–ª—è —Ç–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ ABAC –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã:

- ‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å –ª–∏ –í–∞—Å–µ **—á–∏—Ç–∞—Ç—å** —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω **–≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ–µ–∫—Ç–∞**, –Ω–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç **–µ—â–µ –≤ —Å—Ç–∞—Ç—É—Å–µ Draft**?
- ‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å –ª–∏ –ü–µ—Ç–µ **—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å** –≥–∏–ø–æ—Ç–µ–∑—É, –µ—Å–ª–∏ –µ–≥–æ **—Ä–æ–ª—å = Reviewer**, –Ω–æ **—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è**?
- ‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å –ª–∏ **—Å–∫–∞—á–∞—Ç—å** —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–∏–∑ –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥—ã**, –Ω–æ **–ø—Ä–æ–µ–∫—Ç –ø—É–±–ª–∏—á–µ–Ω**?


## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è ABAC –≤ FastAPI + —Ç–≤–æ—è —Å—Ö–µ–º–∞ –ë–î

### 1. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–æ–≤

```python
# models/attributes.py
from enum import Enum
from datetime import datetime
from sqlalchemy import Column, String, Boolean, DateTime, ForeignKey, JSON
from sqlalchemy.orm import relationship, Mapped

class ExperimentStatus(str, Enum):
    DRAFT = "draft"           # –ß–µ—Ä–Ω–æ–≤–∏–∫
    IN_PROGRESS = "in_progress"
    COMPLETED = "completed"
    ARCHIVED = "archived"

class ProjectStatus(str, Enum):
    ACTIVE = "active"
    PAUSED = "paused"
    CLOSED = "closed"

class Experiment(Base):
    # ... existing fields ...
    
    status: Mapped[ExperimentStatus] = mapped_column(
        default=ExperimentStatus.DRAFT
    )
    is_public: Mapped[bool] = mapped_column(default=False)
    created_by_id: Mapped[uuid.UUID] = mapped_column(ForeignKey("users.id"))
    created_at: Mapped[datetime] = mapped_column(default=datetime.utcnow)
    completed_at: Mapped[datetime | None]
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è ABAC
    metadata_: Mapped[dict] = mapped_column(JSON, default={})
    # –ü—Ä–∏–º–µ—Ä: {"priority": "high", "ml_framework": "pytorch", "gpu_required": True}

class Project(Base):
    # ... existing fields ...
    status: Mapped[ProjectStatus] = mapped_column(default=ProjectStatus.ACTIVE)
    is_public: Mapped[bool] = mapped_column(default=False)
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    metadata_: Mapped[dict] = mapped_column(JSON, default={})
    # –ü—Ä–∏–º–µ—Ä: {"department": "research", "budget_approved": True}

class User(Base):
    # ... existing fields ...
    department: Mapped[str | None]
    clearance_level: Mapped[int] = mapped_column(default=0)  # 0=user, 1=lead, 2=manager
    is_active: Mapped[bool] = mapped_column(default=True)
    last_login: Mapped[datetime | None]
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    metadata_: Mapped[dict] = mapped_column(JSON, default={})
    # –ü—Ä–∏–º–µ—Ä: {"office_location": "Moscow", "specialization": "computer_vision"}
```


### 2. Policy Engine (–î–≤–∏–∂–æ–∫ –ø–æ–ª–∏—Ç–∏–∫)

–°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–æ–ª–∏—Ç–∏–∫ ABAC:

```python
# auth/policy_engine.py
from dataclasses import dataclass
from datetime import datetime
from typing import Dict, Any, List
from enum import Enum
import re

@dataclass
class PolicyContext:
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–æ–ª–∏—Ç–∏–∫–∏"""
    user: User
    resource: Project | Experiment | Hypothesis
    action: str  # "read", "write", "delete", "share"
    environment: Dict[str, Any]  # {"time": datetime, "ip": "...", "device": "..."}

class PolicyCondition(str, Enum):
    """–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –≤ –ø–æ–ª–∏—Ç–∏–∫–∞—Ö"""
    EQUALS = "=="
    NOT_EQUALS = "!="
    GREATER_THAN = ">"
    LESS_THAN = "<"
    IN = "in"
    CONTAINS = "contains"
    MATCHES_REGEX = "regex"

class ABACPolicyEngine:
    """
    –î–≤–∏–∂–æ–∫ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–æ–ª–∏—Ç–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤.
    –ü–æ–ª–∏—Ç–∏–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥–µ.
    """
    
    def __init__(self, db: Session):
        self.db = db
        self.policies = self._load_policies()
    
    def evaluate(self, context: PolicyContext) -> bool:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω.
        """
        # 1. –ë–∞–∑–æ–≤—ã–µ checks (–≤–ª–∞–¥–µ–ª–µ—Ü –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç)
        if self._is_owner(context):
            return True
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–Ω—ã–π DENY (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if self._has_deny_rule(context):
            return False
        
        # 3. –û—Ü–µ–Ω–∏–≤–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏
        for policy in self.policies:
            if policy.applies_to(context):
                if self._evaluate_conditions(policy, context):
                    return True
        
        return False
    
    def _is_owner(self, context: PolicyContext) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º"""
        if hasattr(context.resource, 'owner_id'):
            return context.resource.owner_id == context.user.id
        
        if hasattr(context.resource, 'project_id'):
            # –î–ª—è Experiment/Hypothesis –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ–µ–∫—Ç–∞
            project = context.resource.project
            return project.owner_id == context.user.id
        
        return False
    
    def _has_deny_rule(self, context: PolicyContext) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–Ω—ã–µ –∑–∞–ø—Ä–µ—Ç—ã (DENY)"""
        # –ü—Ä–∏–º–µ—Ä: –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if not context.user.is_active:
            return True
        
        # –ü—Ä–∏–º–µ—Ä: –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ team_members
        if hasattr(context.resource, 'visibility'):
            if context.resource.visibility == ProjectVisibility.PRIVATE:
                if context.user not in context.resource.members:
                    return True
        
        return False
    
    def _evaluate_conditions(self, policy: 'Policy', context: PolicyContext) -> bool:
        """–û—Ü–µ–Ω–∏–≤–∞–µ–º —É—Å–ª–æ–≤–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏"""
        for condition in policy.conditions:
            if not self._eval_condition(condition, context):
                return False
        return True
    
    def _eval_condition(self, condition: Dict[str, Any], context: PolicyContext) -> bool:
        """
        –û—Ü–µ–Ω–∏–≤–∞–µ–º –æ–¥–Ω–æ —É—Å–ª–æ–≤–∏–µ.
        –§–æ—Ä–º–∞—Ç: {"attribute": "experiment.status", "operator": "==", "value": "completed"}
        """
        attr_path = condition.get("attribute")
        operator = condition.get("operator")
        expected_value = condition.get("value")
        
        # –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞
        actual_value = self._get_attribute(attr_path, context)
        
        if actual_value is None:
            return False
        
        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º
        if operator == "==":
            return actual_value == expected_value
        elif operator == "!=":
            return actual_value != expected_value
        elif operator == ">":
            return actual_value > expected_value
        elif operator == "<":
            return actual_value < expected_value
        elif operator == "in":
            return actual_value in expected_value
        elif operator == "contains":
            return expected_value in str(actual_value)
        elif operator == "regex":
            return bool(re.match(expected_value, str(actual_value)))
        
        return False
    
    def _get_attribute(self, attr_path: str, context: PolicyContext) -> Any:
        """
        –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
        –ü—Ä–∏–º–µ—Ä: "user.department" –∏–ª–∏ "resource.status" –∏–ª–∏ "environment.time"
        """
        parts = attr_path.split(".")
        
        if parts[^3_0] == "user":
            obj = context.user
        elif parts[^3_0] == "resource":
            obj = context.resource
        elif parts[^3_0] == "environment":
            obj = context.environment
        elif parts[^3_0] == "action":
            return context.action
        else:
            return None
        
        # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Ü–µ–ø–æ—á–∫–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤
        for part in parts[1:]:
            if isinstance(obj, dict):
                obj = obj.get(part)
            else:
                obj = getattr(obj, part, None)
            
            if obj is None:
                return None
        
        return obj
    
    def _load_policies(self) -> List['Policy']:
        """–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏ –∏–∑ –ë–î –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥–∞"""
        # –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞, —Å–º. —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª
        return []

@dataclass
class Policy:
    """–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª–∏—Ç–∏–∫–∏"""
    name: str
    description: str
    resource_type: str  # "experiment", "project", "hypothesis"
    action: str  # "read", "write", "delete"
    roles: List[str]  # ["editor", "reviewer"]
    conditions: List[Dict[str, Any]]  # –£—Å–ª–æ–≤–∏—è –¥–ª—è –æ—Ü–µ–Ω–∫–∏
    effect: str = "ALLOW"  # "ALLOW" –∏–ª–∏ "DENY"
    priority: int = 0  # –î–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    
    def applies_to(self, context: PolicyContext) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏–º–µ–Ω–∏–º–∞ –ª–∏ —ç—Ç–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ä–µ—Å—É—Ä—Å–∞
        resource_type = context.resource.__class__.__name__.lower()
        if self.resource_type != resource_type:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        if self.action != context.action:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
        user_roles = self._get_user_roles(context)
        if not any(role in self.roles for role in user_roles):
            return False
        
        return True
    
    def _get_user_roles(self, context: PolicyContext) -> List[str]:
        """–ü–æ–ª—É—á–∞–µ–º —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ –ë–î –∏–ª–∏ –∏–∑ TeamRole/ProjectRole)"""
        # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
        roles = []
        
        if hasattr(context.resource, 'team'):
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥–Ω—É—é —Ä–æ–ª—å
            team_role = ...  # query
            if team_role:
                roles.append(team_role.name.lower())
        
        if hasattr(context.resource, 'id'):
            # –ü–æ–ª—É—á–∞–µ–º —Ä–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
            project_role = ...  # query
            if project_role:
                roles.append(project_role.name.lower())
        
        return roles
```


### 3. –ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è —Ç–≤–æ–µ–≥–æ case

```python
# auth/default_policies.py
from auth.policy_engine import Policy, PolicyCondition

DEFAULT_POLICIES = [
    # –ü–æ–ª–∏—Ç–∏–∫–∞ 1: –†–µ–¥–∞–∫—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ DRAFT —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã
    Policy(
        name="edit_draft_experiments",
        description="Editors can only edit draft experiments",
        resource_type="experiment",
        action="write",
        roles=["editor", "admin"],
        conditions=[
            {"attribute": "resource.status", "operator": "==", "value": "draft"}
        ],
        priority=10
    ),
    
    # –ü–æ–ª–∏—Ç–∏–∫–∞ 2: Reviewers –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã, –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –∞–∫—Ç–∏–≤–µ–Ω
    Policy(
        name="reviewer_active_projects",
        description="Reviewers can read experiments from active projects",
        resource_type="experiment",
        action="read",
        roles=["reviewer"],
        conditions=[
            {"attribute": "resource.project.status", "operator": "==", "value": "active"}
        ],
        priority=10
    ),
    
    # –ü–æ–ª–∏—Ç–∏–∫–∞ 3: –ù–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã
    Policy(
        name="no_edit_completed",
        description="No one can edit completed experiments",
        resource_type="experiment",
        action="write",
        roles=["*"],  # Any role
        conditions=[
            {"attribute": "resource.status", "operator": "==", "value": "completed"}
        ],
        effect="DENY",
        priority=100  # High priority for deny rules
    ),
    
    # –ü–æ–ª–∏—Ç–∏–∫–∞ 4: –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è –¥–ª—è sensitive –ø—Ä–æ–µ–∫—Ç–æ–≤
    Policy(
        name="office_hours_sensitive",
        description="Sensitive projects accessible only during office hours",
        resource_type="project",
        action="read",
        roles=["viewer", "editor", "admin"],
        conditions=[
            {"attribute": "resource.metadata_.budget_approved", "operator": "==", "value": True},
            {"attribute": "environment.hour", "operator": ">=", "value": 9},
            {"attribute": "environment.hour", "operator": "<=", "value": 18}
        ],
        priority=20
    ),
    
    # –ü–æ–ª–∏—Ç–∏–∫–∞ 5: –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ–¥–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ –º–æ–≥—É—Ç –¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏
    Policy(
        name="same_department_sharing",
        description="Users from same department can access each other's projects",
        resource_type="project",
        action="read",
        roles=["*"],
        conditions=[
            {"attribute": "user.department", "operator": "==", "value": "resource.metadata_.department"}
        ],
        priority=15
    ),
]
```


### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FastAPI

```python
# auth/dependencies.py
from fastapi import Depends, HTTPException, status
from sqlalchemy.orm import Session
from datetime import datetime

async def require_action(
    action: str,  # "read", "write", "delete", "share"
):
    """Factory –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é"""
    
    async def _check_action(
        current_user: User = Depends(get_current_user),
        db: Session = Depends(get_db),
        project_id: uuid.UUID = None,
        experiment_id: uuid.UUID = None,
    ) -> User:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ—Å—É—Ä—Å
        resource = None
        if experiment_id:
            resource = db.execute(
                select(Experiment).where(Experiment.id == experiment_id)
            ).scalar_one_or_none()
        elif project_id:
            resource = db.execute(
                select(Project).where(Project.id == project_id)
            ).scalar_one_or_none()
        
        if not resource:
            raise HTTPException(status_code=404, detail="Resource not found")
        
        # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context = PolicyContext(
            user=current_user,
            resource=resource,
            action=action,
            environment={
                "time": datetime.utcnow(),
                "hour": datetime.utcnow().hour,
                "day": datetime.utcnow().weekday(),
            }
        )
        
        # –û—Ü–µ–Ω–∏–≤–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏
        engine = ABACPolicyEngine(db)
        if not engine.evaluate(context):
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"Access denied: cannot {action} this resource"
            )
        
        return current_user
    
    return _check_action

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö:
@router.post("/experiments/{experiment_id}/hypotheses")
async def create_hypothesis(
    experiment_id: uuid.UUID,
    hypothesis_name: str,
    current_user: User = Depends(get_current_user),
    _: User = Depends(require_action("write")),  # ‚Üê –ü—Ä–æ–≤–µ—Ä–∫–∞ ABAC
    db: Session = Depends(get_db),
):
    """–°–æ–∑–¥–∞—Ç—å –≥–∏–ø–æ—Ç–µ–∑—É (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–ª–∏—Ç–∏–∫)"""
    # ... –ª–æ–≥–∏–∫–∞ ...
```


### 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ (Admin –ø–∞–Ω–µ–ª—å)

```python
@router.post("/admin/policies")
async def create_policy(
    policy_data: Dict[str, Any],
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–ª–∏—Ç–∏–∫—É"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
    # ...
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –≤ –ë–î –∏–ª–∏ –∫–µ—à
    new_policy = Policy(**policy_data)
    
    # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –∞—É–¥–∏—Ç–∞
    # ...
    
    return {"id": new_policy.id, "name": new_policy.name}

@router.get("/admin/policies/audit")
async def get_audit_log(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """–ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∞—É–¥–∏—Ç–∞"""
    # –í—Å–µ denied attempts –¥–æ–ª–∂–Ω—ã –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è
    return db.execute(select(AccessLog).order_by(-AccessLog.created_at)).all()
```


## ABAC vs RBAC –≤ —Ç–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏

| –°—Ü–µ–Ω–∞—Ä–∏–π | RBAC | ABAC |
| :-- | :-- | :-- |
| "–í–∞—Å—è ‚Äî Editor" | ‚úÖ –ú–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã | ‚ùå –ú–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ Draft —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã |
| "–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è" | ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ | ‚úÖ –û–¥–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞: `resource.time >= 9 AND time <= 18` |
| "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ–¥–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ –≤–∏–¥—è—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞" | ‚ùå –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–Ω–æ–≥–æ —Ä–æ–ª–µ–π | ‚úÖ `user.department == resource.owner.department` |
| "–†–∞–∑–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –ø—Ä–∞–≤ –¥–ª—è Draft vs Completed" | ‚ùå –ù—É–∂–Ω–æ –º–Ω–æ–≥–æ —Ä–æ–ª–µ–π | ‚úÖ –£—Å–ª–æ–≤–∏–µ: `resource.status` |

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

–ù–∞—á–Ω–∏ —Å **–≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞**:

1. **RBAC** –∫–∞–∫ –æ—Å–Ω–æ–≤–∞ (Admin, Editor, Viewer)
2. **ABAC** –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö case (—Å—Ç–∞—Ç—É—Å—ã, –≤—Ä–µ–º—è, –∞—Ç—Ä–∏–±—É—Ç—ã)

–≠—Ç–æ –¥–∞—Å—Ç —Ç–µ–±–µ –ø—Ä–æ—Å—Ç–æ—Ç—É –±–∞–∑–æ–≤—ã—Ö —Ä–æ–ª–µ–π + –≥–∏–±–∫–æ—Å—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–π. üöÄ
<span style="display:none">[^3_1][^3_10][^3_11][^3_12][^3_13][^3_14][^3_15][^3_2][^3_3][^3_4][^3_5][^3_6][^3_7][^3_8][^3_9]</span>

<div align="center">‚ÅÇ</div>

[^3_1]: https://www.permit.io/blog/how-to-implement-abac

[^3_2]: https://www.barracuda.com/support/glossary/rbac-vs-abac

[^3_3]: https://www.permit.io/blog/implement-authorization-in-fastapi

[^3_4]: https://www.knostic.ai/blog/attribute-based-access-control-example

[^3_5]: https://www.splunk.com/en_us/blog/learn/rbac-vs-abac.html

[^3_6]: https://www.reddit.com/r/FastAPI/comments/1jn1203/how_do_you_handle_rebac_abac_and_rbac_in_fastapi/

[^3_7]: https://workos.com/blog/attribute-based-access-control-example

[^3_8]: https://www.okta.com/identity-101/role-based-access-control-vs-attribute-based-access-control/

[^3_9]: https://dev.to/mochafreddo/building-a-modern-user-permission-management-system-with-fastapi-sqlalchemy-and-mariadb-5fp1

[^3_10]: https://auth0.com/blog/what-is-abac-and-how-to-implement-it-rails-api/

[^3_11]: https://frontegg.com/guides/rbac-vs-abac

[^3_12]: https://www.permit.io/blog/fastapi-rbac-full-implementation-tutorial

[^3_13]: https://netwrix.com/en/resources/blog/attribute-based-access-control-abac/

[^3_14]: https://www.permit.io/blog/rbac-vs-abac

[^3_15]: https://auth0.com/blog/rebac-abac-openfga-cedar/


---

# –ê –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ?

–í–æ—Ç –ø–æ–ª–Ω—ã–π –æ–±–∑–æ—Ä! –ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–ª–∏—á–Ω—ã—Ö –≥–æ—Ç–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π:

## –¢–æ–ø 4 –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è FastAPI[^4_1][^4_2][^4_3]

### 1. **Casbin (PyCasbin)** ‚Äî –ú–æ–π —Ç–æ–ø –≤—ã–±–æ—Ä –¥–ª—è —Ç–≤–æ–µ–≥–æ case ‚≠ê

```python
pip install pycasbin
```

**–ü–æ—á–µ–º—É:**

- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç RBAC + ABAC + ACL –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ –í—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–¥ (embedded), –Ω–µ –Ω—É–∂–µ–Ω –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å
- ‚úÖ –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –õ–µ–≥–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –≤ FastAPI

**–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:**

```python
from pycasbin import Enforcer

enforcer = Enforcer("model.conf", "policy.csv")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
if enforcer.enforce("vasya", "/projects/123", "write", "experiment"):
    # –†–∞–∑—Ä–µ—à–∞–µ–º
else:
    # –ó–∞–ø—Ä–µ—â–∞–µ–º
```


***

### 2. **Oso** ‚Äî –°–∞–º–æ–µ –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ

```python
pip install oso
```

**–ü–æ—á–µ–º—É:**

- ‚úÖ –°—É–ø–µ—Ä –ø—Ä–æ—Å—Ç–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (—è–∑—ã–∫ Polar)
- ‚úÖ RBAC + ABAC + ReBAC –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
- ‚úÖ –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è

**–ü—Ä–∏–º–µ—Ä:**

```python
from oso import Oso

oso = Oso()
oso.load_str("""
allow(actor, "write", experiment) if
  actor.role = "editor" and
  experiment.status = "draft";
""")

allowed = oso.is_allowed(user, "write", experiment)
```


***

### 3. **Permit.io** ‚Äî –î–ª—è Enterprise[^4_4][^4_5]

```python
pip install permit-python-sdk
```

**–ü–æ—á–µ–º—É:**

- ‚úÖ Cloud-hosted (–Ω–µ –Ω—É–∂–Ω–æ —Å–∞–º–æ–º—É —É–ø—Ä–∞–≤–ª—è—Ç—å)
- ‚úÖ UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏
- ‚úÖ Multi-tenant –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- ‚úÖ –ê—É–¥–∏—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
from permit import Permit

permit = Permit(token="your_api_key")

allowed = await permit.check(
    user_id="vasya",
    action="write",
    resource={"type": "experiment"}
)
```


***

### 4. **py-abac** ‚Äî –ß–∏—Å—Ç–æ–µ ABAC[^4_6][^4_7]

```python
pip install py-abac
```

**–ü–æ—á–µ–º—É:**

- ‚úÖ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ ABAC
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç XACML (Enterprise-grade)

***

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–ª—è —Ç–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Casbin | Oso | Permit.io | py-abac |
| :-- | :-- | :-- | :-- | :-- |
| RBAC | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| ABAC | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ‚úÖ |
| –ü—Ä–æ—Å—Ç–æ—Ç–∞ | 7/10 | 9/10 | 8/10 | 6/10 |
| Performance | 9/10 | 7/10 | 8/10 | 7/10 |
| –í—Å—Ç—Ä–æ–µ–Ω–æ | ‚úÖ | ‚úÖ | ‚ùå Cloud | ‚úÖ |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 8/10 | 9/10 | 8/10 | 6/10 |


***

## –ú–æ–π —Ä–µ—Ü–µ–ø—Ç –¥–ª—è —Ç–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:

**–ù–∞—á–Ω–∏ —Å Casbin**, –ø–æ—Ç–æ–º—É —á—Ç–æ:

1. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–∏ RBAC –∏ ABAC** (–∫–∞–∫ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–≤–æ–µ–≥–æ case)
2. **–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π** (embedded) ‚Äî –Ω–µ –Ω—É–∂–Ω—ã –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
3. **–ë—ã—Å—Ç—Ä—ã–π** ‚Äî –≤—Å—ë –≤ –ø–∞–º—è—Ç–∏
4. **–ì–∏–±–∫–∏–π** ‚Äî –ª–µ–≥–∫–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö —Ä–æ–ª–µ–π –∫ —Å–ª–æ–∂–Ω—ã–º –ø–æ–ª–∏—Ç–∏–∫–∞–º

–í–æ—Ç –≥–æ—Ç–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä –¥–ª—è —Ç–≤–æ–µ–≥–æ DL –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

```python
# model.conf
[request_definition]
r = sub, obj, act, status

[policy_definition]
p = sub, obj, act, status, eft

[policy_effect]
e = some(where (p.eft == allow)) && !some(where (p.eft == deny))

[matchers]
m = r.sub == p.sub && r.obj == p.obj && r.act == p.act && r.status == p.status
```

```python
# policy.csv
# –†–µ–¥–∞–∫—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ draft
p, editor, experiment, write, draft, allow
p, editor, experiment, write, completed, deny

# Viewers —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç
p, viewer, experiment, read, *, allow
p, viewer, experiment, write, *, deny

# Admins –º–æ–≥—É—Ç –≤—Å—ë
p, admin, *, *, *, allow

# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π
g, vasya, editor
g, petya, viewer
```

–•–æ—á–µ—à—å, —è –ø–æ–∫–∞–∂—É –ø–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å FastAPI + SQLAlchemy + Casbin?
<span style="display:none">[^4_10][^4_11][^4_12][^4_13][^4_14][^4_15][^4_16][^4_8][^4_9]</span>

<div align="center">‚ÅÇ</div>

[^4_1]: https://permify.co/post/open-source-authorization-libraries/

[^4_2]: https://permify.co/post/top-axiomatics-alternatives/

[^4_3]: https://www.permit.io/blog/best-practices-for-authorization-in-python

[^4_4]: https://www.permit.io/blog/fastapi-rbac-full-implementation-tutorial

[^4_5]: https://www.permit.io/blog/implement-authorization-in-fastapi

[^4_6]: https://pypi.org/project/py-abac/0.2.0/

[^4_7]: https://lab.abilian.com/Tech/Python/Useful Libraries/Access control in Python/

[^4_8]: https://www.reddit.com/r/FastAPI/comments/1jn1203/how_do_you_handle_rebac_abac_and_rbac_in_fastapi/

[^4_9]: https://authzed.com/blog/casbin

[^4_10]: https://auth0.com/blog/implementing-rbac-fastapi-auth0-fga/

[^4_11]: https://www.osohq.com/learn/aws-cedar-alternatives-authorization-tools

[^4_12]: https://www.permit.io/tags/implementation-guide

[^4_13]: https://www.reddit.com/r/devops/comments/1hsq81f/any_recommendations_for_open_source_rbac/

[^4_14]: https://github.com/casbin/pycasbin

[^4_15]: https://github.com/pycasbin

[^4_16]: https://slashdot.org/software/p/Casbin/alternatives


---

# –¢–∞–∫, –º–Ω–µ –Ω—É–∂–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, —Ç–∞–∫ —á—Ç–æ –ø—Ä–∞–≤–∏–ª–∞ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –±–¥, —á—Ç–æ –ø–æ–¥

–í–æ—Ç –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è! –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞[^5_1][^5_2][^5_3]

### 1. **–¢–∞–±–ª–∏—Ü–∞ `casbin_rules`** ‚Äî —Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏

```
| id | ptype | v0        | v1       | v2    | v3           | team_id |
|----|-------|-----------|----------|-------|--------------|---------|
| 1  | p     | editor    | /projects| write | experiment   | team-123|
| 2  | g     | vasya_id  | editor   | NULL  | NULL         | team-123|
| 3  | p     | viewer    | /projects| read  | experiment   | team-123|
```


### 2. **CasbinEnforcerManager** ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã

- –°–æ–∑–¥–∞—ë—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π `enforcer` –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
- –ö–µ—à–∏—Ä—É–µ—Ç enforcers –≤ –ø–∞–º—è—Ç–∏
- –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–µ—à –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–∏—Ç–∏–∫


### 3. **API endpoints –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏**

```python
# –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É
POST /teams/{team_id}/policies
?subject=editor&obj=/projects&act=write&eft=allow

# –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
POST /teams/{team_id}/roles
{"user_identifier": "vasya_id", "role_name": "editor"}

# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏
GET /teams/{team_id}/policies
```


### 4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ**

```python
@router.post("/projects/{project_id}/experiments")
async def create_experiment(
    project_id: uuid.UUID,
    # ... –ø—Ä–æ–≤–µ—Ä–∫–∞ Casbin –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å!
    _: User = Depends(require_casbin_permission("write", "experiment")),
):
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ ‚Üí 403
```


## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```bash
# 1. –°–æ–∑–¥–∞–µ–º –∫–æ–º–∞–Ω–¥—É "ML Engineers"
POST /teams
{"name": "ML Engineers"}
# –û—Ç–≤–µ—Ç: {"id": "team-123", ...}

# 2. –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É: —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã
POST /teams/team-123/policies?subject=editor&obj=/projects&act=write&resource_type=experiment&eft=allow

# 3. –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É: viewers —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç
POST /teams/team-123/policies?subject=viewer&obj=/projects&act=read&resource_type=experiment&eft=allow

# 4. –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª—å –í–∞—Å–µ
POST /teams/team-123/roles
{"user_identifier": "vasya_id", "role_name": "editor"}

# 5. –¢–µ–ø–µ—Ä—å –í–∞—Å—è –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã!
POST /projects/proj-123/experiments
{"name": "Training v1"}
# ‚úÖ Success

# 6. –ù–æ –ü–µ—Ç—è (viewer) –Ω–µ –º–æ–∂–µ—Ç:
POST /projects/proj-123/experiments  # –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è petya_id
# ‚ùå 403 Forbidden - –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ write –Ω–∞ experiment
```


## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

‚úÖ **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏** ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ API
‚úÖ **Per-team policies** ‚Äî —Ä–∞–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
‚úÖ **–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –≤—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
‚úÖ **–ê—É–¥–∏—Ç** ‚Äî –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ –∏–∑–º–µ–Ω–∏–ª –ø–æ–ª–∏—Ç–∏–∫–∏
‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** ‚Äî –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ª–∏—Ç–∏–∫

–•–æ—á–µ—à—å, —è –ø–æ–∫–∞–∂—É, –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å **UI –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫** –∏–ª–∏ **–∞—É–¥–∏—Ç –ª–æ–≥–∏**? üöÄ
<span style="display:none">[^5_10][^5_11][^5_12][^5_13][^5_14][^5_15][^5_4][^5_5][^5_6][^5_7][^5_8][^5_9]</span>

<div align="center">‚ÅÇ</div>

[^5_1]: https://pypi.org/project/casbin-async-sqlalchemy-adapter/

[^5_2]: https://pypi.org/project/sqlalchemy-adapter/

[^5_3]: https://casbin.org/docs/api-overview/

[^5_4]: https://hrekov.com/blog/casbin-hierarchical-rbac-maintenance

[^5_5]: https://www.npmjs.com/package/casbin-basic-adapter

[^5_6]: https://github.com/msales/casbin-bun-adapter

[^5_7]: https://casbin.org/docs/adapters/

[^5_8]: https://stackoverflow.com/questions/76386688/how-can-i-link-a-collection-of-users-to-policy-rules-of-a-single-resource-using

[^5_9]: https://casbin.org

[^5_10]: https://casbin.org/ecosystem/

[^5_11]: https://klotzandrew.com/blog/authorization-with-casbin/

[^5_12]: https://pkg.go.dev/github.com/casbin/casbin-pg-adapter

[^5_13]: https://casbin.org/docs/get-started/

[^5_14]: https://github.com/casbin/casbin/issues/596

[^5_15]: https://github.com/casbin/gorm-adapter


---

# –¢–∞–∫, –∫–∞–∫–æ–π –∫–æ–¥ —Ç–æ–≥–¥–∞ –Ω–∞–¥–æ –Ω–∞–ø–∏—Å–∞—Ç—å?

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è –µ—Å—Ç—å **–ø–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –∫–æ–¥**. –í–æ—Ç –∫—Ä–∞—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç:

## ‚úÖ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### 1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**

```bash
pip install fastapi uvicorn sqlalchemy pycasbin sqlalchemy-adapter
```


### 2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**

```bash
python complete_fastapi_app.py
```


### 3. **–û—Ç–∫—Ä—ã—Ç—å Swagger UI**

```
http://localhost:8000/docs
```


***

## üìã –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ –∫–æ–¥

‚úÖ **Database Models** (User, Team, Project, Experiment, Hypothesis, CasbinRule)
‚úÖ **RBAC —Å —Ç—Ä–µ–º—è —Ä–æ–ª—è–º–∏** (admin, editor, viewer)
‚úÖ **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ –ë–î** (—Ç–∞–±–ª–∏—Ü–∞ casbin_rules)
‚úÖ **CasbinEnforcerManager** (–º–µ–Ω–µ–¥–∂–µ—Ä enforcer'–æ–≤ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º)
‚úÖ **FastAPI endpoints** –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤** —á–µ—Ä–µ–∑ Depends()
‚úÖ **API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏** (add, delete, list)
‚úÖ **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤—ã—Ö –ø–æ–ª–∏—Ç–∏–∫** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã

***

## üîë –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤:**

```python
@router.post("/projects/{project_id}/experiments")
async def create_experiment(
    project_id: str,
    experiment: ExperimentCreate,
    current_user: User = Depends(get_current_user),
    # ‚Üì –í–æ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Casbin!
    _: User = Depends(require_casbin_permission("write", "experiment")),
    db: Session = Depends(get_db),
):
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å -> 403 Forbidden
    # –ï—Å–ª–∏ –º–æ–∂–µ—Ç -> —Å–æ–∑–¥–∞—ë–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
```

**–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ø–æ–ª–∏—Ç–∏–∫—É:**

```python
# 1. –ß–µ—Ä–µ–∑ API
POST /teams/{team_id}/policies
{
    "subject": "reviewer",
    "obj": "/experiments",
    "act": "read",
    "resource_type": "experiment",
    "eft": "allow"
}

# 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±–∞–∑–æ–≤—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
# (—Å–º. —Ñ—É–Ω–∫—Ü–∏—é _init_team_default_policies)
```


***

## üìÅ –§–∞–π–ª—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

–£ —Ç–µ–±—è –µ—Å—Ç—å –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–∞:

1. **`complete_fastapi_app.py`** ‚Äî –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (882 —Å—Ç—Ä–æ–∫–∏, –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É)
2. **`SETUP_AND_RUN.md`** ‚Äî –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ curl'–æ–≤

–ü—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π `complete_fastapi_app.py`, —É—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∑–∞–ø—É—Å—Ç–∏! üöÄ

